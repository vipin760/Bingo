/*!
 * flxMenu v1.0
 * https://github.com/LTS-Tools/flxMenu
 *
 * Copyright (c) 2018 Alfred Lorenz.  All rights reserved.
 * Released under the MIT license.
 *
 * Date: Thu Jul 12 2018
 */
(function(a){if(a.fn.flxMenu){return}a.fn.flxMenu=function(i,j){var c={puTop:0,puLeft:1,puRight:2};var r={fnChanged:function(J,K,I){v(true,"Moved bar from {1} to {0}",K[0].id,I[0].id)},fnInit:function(I,J){},fnSubmenuClosing:function(I){v(true,'closing submenu of <{0} id="{1}">',I[0].nodeName,I.attr("id"))},fnPopupShowing:function(I){v(true,"Popup showing {0} ",I)},duration:300,orientation:"horizontal",smShowByClick:false,puSlideInFrom:"top",puCloseOnSelect:false,puShowActiveItem:false,puAligned:false,puFullRange:true,puAutoWidth:false,smFilterClass:false,framework:false,debug:false};if(!a.fn.flxLog){if(j.debug){console.log('flxMenu: !!! load "debug.js" for logging outputs !!!')}a.fn.flxLog=function(){}}function h(I,J){v(true,"DoNothing called on "+J.attr("id"))}function A(I,J){$li=a(I.target).closest("li");if($li.is(J)){w(J,1)}I.stopPropagation()}function D(I,J){I.preventDefault();w(J)}function n(I,J){I.preventDefault();t(J)}if(this.length==0){v(true,'No element found for "'+this.selector+'".');return this}if(this.length>1){v(true,'Found more than one element for "'+this.selector+'".');v(true,'Only handle the first: "'+this[0].id+'".');a(this[0]).flxMenu(i,j);return this}if(this.data("flxMenu")){v(true,"flxMenu has already been applied");return}var l=this;this.data("flxMenu",true);var j=a.extend({},r,j||{});l.addClass("flxMenu");function v(I,L,R,Q,P,O,N,M,K,J){if(I){a.fn.flxLog(L,R,Q,P,O,N,M,K,J)}}function x(I){$root=I.closest(".flxMenu");return $root[0].flxOptions}function B(I){$frame=I.children("ul, div").first().css({overflow:"hidden",height:0});I.removeClass("displaySubmenu")}function t(L,I){var K=x(L);if(K.framework=="lyraT4"){if(window.editPermissions){ltxCancelForm()}}K.fnSubmenuClosing(L);L.removeClass("inProgrOpen");var J=L.children("ul, div").first();J.stop(true,false);if(I){L.children("ul, div").first().css("overflow","hidden").animate({height:0},K.duration);L.removeClass("displaySubmenu");L.find(".displaySubmenu").each(function(){var M=a(this);M.children("ul, div").first().css("overflow","hidden").animate({height:0},K.duration);M.removeClass("displaySubmenu")})}else{B(L);L.find(".displaySubmenu").each(function(){B(a(this))})}a(document).off("click.flxMenu")}function w(N,O){if(!N.hasClass("hasSubmenu")){return false}if(N.hasClass("displaySubmenu")&&(O==1)){t(N,true);return false}if(N.hasClass("inProgrOpen")||N.hasClass("displaySubmenu")){return true}var I=x(N);N.siblings("li.displaySubmenu").each(function(){t(a(this),O)});if(I.smShowByClick&&!I.popup){a(document).on("click.flxMenu",function(T){var S=a(T.target).closest(".flxInitFrame");if(S.length){console.log("clicked on item of mainMenu")}else{t(N,true)}})}var R=N.children("ul, div");var L=a(R[0]);L.removeClass("leftAligned");var K=L.offset();var J=L.width();var M=L.css("min-width");L.css("position","fixed");L.css("min-width",0);L.css("left",-9999);L.css("width",J);L.css("height","auto");subH=L.outerHeight()+3;v(I.debug,"__flxOpenSubmenu - sub frame calculated h: {0}",subH);if(a(window).scrollLeft()+a(window).width()<(K.left+J)){L.addClass("leftAligned")}L.css("position","");L.css("left","");L.css("height",0);L.css("width","");L.css("min-width",M);var Q=N.parent().closest(".displaySubmenu").children("ul, div");if(Q.length>0){var P=a(Q[0]);v(I.debug,"__flxOpenSubmenu - parent sub frame: <{0}>",Q[0].nodeName);P.css("height","auto");P.css("overflow","visible")}N.addClass("inProgrOpen");L.animate({height:subH+"px"},I.duration,function(){N.removeClass("inProgrOpen")});N.addClass("displaySubmenu");return L}function o(J,O,N,I,L){var M=x(J);v(M.debug,"flxMenuCheckPosition({0}, {1}, {2})",J[0].id,O[0].id,N[0].id);v(M.debug,"- flxOptions.popup: {0}",M.popup);var K=false;if(M.thW){v(M.debug,"- flxOptions.thW: {0}",M.thW);if(O.innerWidth()<M.thW){I.show()}else{I.css("display","none")}}if(I.css("display")!="none"){K=true}$Li=J.find("li");$Li.each(function(){if(a(this).hasClass("displaySubmenu")){B(a(this))}});if(K){if((!M.popup)||L){J[0].onItemEnter=h;J[0].onItemLeave=h;J[0].onItemClick=A;I.show();N.append(J);M.popup=true;if(M.framework=="lyraT4"){if(window.editPermissions){I.find(".ltxContainer").addClass("ltx-locked");if(!L){ltxCancelForm()}}}M.fnChanged(true,I,O)}}else{I.removeClass("showUp");I.children(".menuFrame").hide();if(M.popup||L){if(M.smShowByClick){J[0].onItemEnter=h;J[0].onItemLeave=h;J[0].onItemClick=A}else{J[0].onItemEnter=D;J[0].onItemLeave=n;J[0].onItemClick=h}O.prepend(J);M.popup=false;if(M.framework=="lyraT4"){if(window.editPermissions){I.find(".ltxContainer").removeClass("ltx-locked")}}M.fnChanged(false,O,I)}O.show();$Li.first().find("a:first").focus()}}function k(L,O,K,J){v(K.debug,"__flxFindTargetInFrame(<{0}>, {1}, {2})",L[0].nodeName,O,J);var N=L.parent();if(N.is("li")){if(J){return[]}return N}var M=1;if(J){M=-1}$pFrameChildren=N.children().filter(function(){if(this==L[0]){v(K.debug,"remove element <{0}> from frame set",this.nodeName);return false}var Q=a(this).offset().left;var P=O.left-Q;if(P*M<5){v(K.debug,"remove element <{0}> from frame set; left: {1} ",this.nodeName,Q);return false}return true});if($pFrameChildren.length>0){var I=9999;$target=[];$pFrameChildren.find("li").each(function(){var R=a(this).offset();v(K.debug,"compare <li> {0} with {1}",R,O);var Q=(O.left-R.left)*M;if(Q>5){var P=Math.abs(O.top-R.top);if(P<I){v(K.debug,"setting bestDY {0} to {1}",I,P);I=P;$target=a(this)}}});return $target}else{return k(N,O,K,J)}}function m(K,P,J,O){v(J.debug,"__flxFindTargetInFrameV(<{0}>, {1})",K[0].nodeName,O);var M=K.parent();if(M.is("li")){if(J.popup){if(O){return M}return M.next()}if(O){t(P);return M}return[]}var L=1;if(O){L=-1}var N=P.offset();$pFrameChildren=M.children().filter(function(){if(this==K[0]){v(J.debug,"remove element <{0}> from frame set",this.nodeName);return false}var R=a(this).offset().top;var Q=R-N.top;if(Q*L<20){v(J.debug,"remove element <{0}> from frame set; top: {1} ",this.nodeName,R);return false}return true});if($pFrameChildren.length>0){var I=9999;$target=[];$pFrameChildren.find("li").each(function(){var S=a(this).offset();v(J.debug,"compare <li> {0} with {1}",S,N);var R=(S.top-N.top)*L;if(R>5){var Q=Math.abs(N.top-S.top);if(Q<I){v(J.debug,"setting bestDY {0} to {1}",I,Q);I=Q;$target=a(this)}}});return $target}return m(M,P,J,O)}function d(O,K){var N=O.children(".menuFrame");var L=N.children(".menuSlider");var J=L.children(".flxMenu");var M=J[0].flxOptions;v(M.debug,'"menuShow" triggered');var I;$Li=J.find("li");$Li.each(function(){if(a(this).hasClass("active")){I=a(this).children("a");if(!I.prop("href")){I.prop("href","javascript:")}a(this).parentsUntil(".flxMenu","li").each(function(P){$parentLi=a(this);$parentLi.addClass("displaySubmenu");$parentLi.children("ul, div").first().css("height","auto")})}else{B(a(this))}});if(K){E(N,L,M,K)}else{z(N,L,M)}N.parent().addClass("showUp");if(!I){I=$Li.first().find("a:first")}v(M.debug,"try to set focus to {0}",I.text());I.focus();M.fnPopupShowing(true,O)}function E(O,M,N,K){var L="left";var I="right";if(K==c.puRight){L="right";I="left"}O.css("display","block");if(N.puAligned){O.css(L,"100%")}else{O.css(L,0)}O.css(I,"auto");O.css("width",0);O.css("overflow","hidden");M.css("position","fixed");M.css(I,"auto");M.css(L,-9999);var J=M.outerWidth()+3;if(N.puFullRange){O.css("position","fixed");O.css("height","100%");M.css("height","100%")}else{O.css("height",M.outerHeight())}v(N.debug,"flxPopupMoveInHoriz - menu w: {0}",J);M.css("position","");M.css(L,0);M.css(I,"auto");M.addClass("inProgrOpen");O.animate({width:J},N.duration,function(){M.removeClass("inProgrOpen");O.parent().addClass("showUp");O.css("overflow","")})}function z(K,I,J){K.css("display","block");if(J.puAligned){K.css("top","100%")}else{K.css("top",0)}K.css("height",0);K.css("overflow","hidden");I.css("position","fixed");I.css("bottom","auto");I.css("top",-9999);var L=I.outerHeight();v(J.debug,"flxPopupMoveInTop - menu calculated h: {0}",L);I.css("position","");I.css("bottom",0);I.css("top","auto");if(J.puFullRange){if(!J.puAligned){K.css("position","fixed")}K.css("left","0");K.css("width","100%");I.css("width","100%")}else{K.css("width",I.outerWidth())}I.addClass("inProgrOpen");K.animate({height:L},J.duration,function(){I.removeClass("inProgrOpen");K.parent().addClass("showUp");K.css("overflow","");I.css("bottom","auto");I.css("top",0)})}function C(N,J){var M=N.children(".menuFrame");var K=M.children(".menuSlider");var I=K.children(".flxMenu");var L=I[0].flxOptions;v(L.debug,'"menuClose" triggered');M.css("overflow","hidden");if(J){H(M,K,L)}else{F(M,K,L)}N.removeClass("showUp");N.children("a").first().focus();L.fnPopupShowing(false,N)}function F(K,I,J){K.animate({height:0},J.duration,function(){K.parent().removeClass("showUp");K.css("display","none")})}function H(L,J,K){var I=J.outerWidth()+3;v(K.debug,"flxPopupMoveOutLeft - menu w: {0}",I);L.css("height",J.outerHeight());L.animate({width:0},K.duration,function(){L.parent().removeClass("showUp");L.css("display","none")})}function g(I){d(a(this))}function q(I){d(a(this),c.puLeft)}function f(I){d(a(this),c.puRight)}function u(I){C(a(this),c.puLeft)}function b(I){C(a(this),c.puRight)}function p(I){C(a(this))}function e(I){if(I.flxOptions.popup){v(I.flxOptions.debug,"flxCalcTHW: temporarily changing to desktop mode");a(I.initialFrame).prepend(I)}var J=0;a(I).children("li").each(function(){J+=a(this).outerWidth(true)});I.flxOptions.thW=J+I.flxOptions.puAutoWidth;v(I.flxOptions.debug,'set thw to "{0}px"',I.flxOptions.thW)}function s(J,I){v(J.flxOptions.debug,"flxRegisterItem");a(I).parentsUntil(J).filter("li").each(function(){var K=a(this);K.addClass("hasSubmenu");K.on("click",function(L){J.onItemClick(L,K)});K.on("mouseenter",function(L){J.onItemEnter(L,K)});K.on("mouseleave",function(L){J.onItemLeave(L,K)})});if(J.flxOptions.puAutoWidth&&(I.parentNode==J)){e(J);a(J).triggerHandler("flxMenuCheck")}}function G(J,K){v(J.flxOptions.debug,"flxUnregisterItem");if(K.parentNode==J){J.removeChild(K);if(J.flxOptions.puAutoWidth){e(J);a(J).triggerHandler("flxMenuCheck")}}else{var I=K.parentNode;I.removeChild(K);if(!I.hasChildNodes()){a(I).closest("li").removeClass("hasSubmenu")}}}function y(I,R){v(j.debug,"init with options: {0}",j);I.target=R[0];if(j.puSlideInFrom!="top"){j.puAligned=false}var Q=R.children("a").first();if(Q.length>0){if(Q.hasClass("flxMenuToggle")){Q.click(function(){a(this).trigger("menuToggle")});j.puAligned=true}else{Q.addClass("flxMenuOpen");Q.click(function(){a(this).trigger("menuShow")})}}else{var L="";if(j.img){L='<img class="menuSymbol" src="'+j.img+'" />'}else{L='<ul class="menuSymbol"><li></li><li></li><li></li></ul>'}if(j.puAligned){var N='<a href="javascript:" class="flxMenuToggle">'+L+"</a>";Q=a(N);Q.click(function(){a(this).trigger("menuToggle")})}else{var N='<a href="javascript:" class="flxMenuOpen">'+L+"</a>";Q=a(N);Q.click(function(){a(this).trigger("menuShow")})}R.prepend(Q)}var J=R.children(".menuFrame");if(J.length==0){var O="";if(!Q.hasClass("flxMenuToggle")){O='<a href="javascript:" title="close" class="menuClose" onclick="$(this).trigger(\'menuClose\')"> </a>'}var P='<div class="menuFrame"><div class="menuSlider">'+O+"</div></div>";R.append(a(P))}if(!I.id){I.id="flxMenu"}var M=a(I);$menuButtons=M.find("a");$menuButtons.on("keydown",function(S){var W=x(a(this));v(W.debug,"keydown code {1} on {0}",a(this).text(),S.which);switch(S.which){case 27:S.preventDefault();a(this).trigger("menuClose");break;case 13:$Li=a(this).closest("li");if($Li.hasClass("hasSubmenu")){S.preventDefault();w($Li)}break;case 40:S.preventDefault();$Li=a(this).closest("li");var V=[];var U=$Li.css("float");if((U=="left")||(U=="right")){if($Li.hasClass("hasSubmenu")){w($Li);V=$Li.find("li:first")}}else{V=$Li.next();if(V.length==0){V=m($Li.parent(),$Li,W);if(V.length==0){break}U=V.css("float");if((U=="left")||(U=="right")){break}}else{if(!W.popup){t($Li)}}}if(V.length>0){V.find("a:first").focus()}break;case 38:S.preventDefault();$Li=a(this).closest("li");var U=$Li.css("float");if((U=="left")||(U=="right")){if($Li.hasClass("displaySubmenu")){t($Li)}break}var V=$Li.prev();if(V.length==0){V=m($Li.parent(),$Li,W,true)}else{if(!W.popup){t($Li)}}if(V.length>0){V.find("a:first").focus()}break;case 37:S.preventDefault();$Li=a(this).closest("li");if($Li.hasClass("displaySubmenu")){t($Li);break}var V=[];var U=$Li.css("float");if(U=="left"){V=$Li.prev()}else{if(U=="right"){V=$Li.next()}else{var T=$Li.parent();V=k(T,$Li.offset(),W);if(V.length==0){V=T.closest("li")}}}if(V.length>0){V.find("a:first").focus()}break;case 39:S.preventDefault();$Li=a(this).closest("li");var V=[];var U=$Li.css("float");if(U=="left"){if(!W.popup){t($Li)}V=$Li.next()}else{if(U=="right"){if(!W.popup){t($Li)}V=$Li.prev()}else{if($Li.hasClass("hasSubmenu")){w($Li,39);V=$Li.find("li:first")}else{V=k($Li.parent(),$Li.offset(),W,true)}}}if(V.length>0){V.find("a:first").focus()}break}});if(j.framework=="lyraT4"){if(window.editPermissions){v(j.debug,'setting "smShowByClick" in lyraT4 edit mode');j.smShowByClick=true}}if(j.puCloseOnSelect){$menuButtons.on("click",function(){if(!a(this).closest("li").hasClass("hasSubmenu")){a(this).trigger("menuClose")}})}var K=j.initialFrame;if(!K||K.length==0){v(j.debug,'build elemFrame around "{0}"',I.id);M.wrap('<div id="flxFrame'+I.id+'"></div>');K=a(I).parent()}I.initialFrame=K[0];K.addClass("flxInitFrame");if(j.orientation=="vertical"){K.addClass("flx-vertical")}M.find("li").each(function(){var S=a(this);if(S.find("li").length>0){S.addClass("hasSubmenu");S.on("click",function(T){M[0].onItemClick(T,S)});S.on("mouseenter",function(T){M[0].onItemEnter(T,S)});S.on("mouseleave",function(T){M[0].onItemLeave(T,S)})}});R.addClass("menuTrigger");if(j.puSlideInFrom=="left"){R.on("menuClose",u).on("menuShow",q);R.addClass("flx-left")}else{if(j.puSlideInFrom=="right"){R.on("menuClose",b).on("menuShow",f);R.addClass("flx-right")}else{R.on("menuClose",p).on("menuShow",g)}}R.on("menuToggle",function(){if(a(this).hasClass("showUp")){a(this).triggerHandler("menuClose")}else{a(this).triggerHandler("menuShow")}});M.on("flxMenuCheck",function(){var S=a(this.target);o(M,a(this.initialFrame),S.children(".menuFrame").children(".menuSlider"),S)}).on("flxMenuRegisterItem",function(T,S,U){if(U){G(this,S)}else{s(this,S)}}).on("flxMenuOptions",function(S,U){this.flxOptions=a.extend({},this.flxOptions,U);var T=x(a(this));v(true,'flxMenuOptions changed options: "{0}"',T)});a(window).on("resize",function(){a(I).trigger("flxMenuCheck")});I.flxOptions=j;if(j.puAutoWidth){e(I)}o(M,K,R.children(".menuFrame").children(".menuSlider"),R,true);j.fnInit(M,K,R)}y(this[0],i);return this}}(jQuery));